<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Controls</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #101010;
        color: #f5f5f5;
        min-height: 100vh;
      }

      a {
        color: inherit;
      }

      .hidden {
        display: none !important;
      }

      .auth-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.75);
        padding: 1.5rem;
        backdrop-filter: blur(2px);
        z-index: 20;
      }

      .auth-card {
        background: rgba(18, 18, 18, 0.95);
        border-radius: 1rem;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: min(90vw, 360px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      }

      .auth-card h1 {
        font-size: 1.4rem;
        text-align: center;
      }

      .auth-field {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.95rem;
      }

      .auth-field input {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.35);
        color: #fff;
        padding: 0.65rem 1rem;
        font-size: 1rem;
      }

      .auth-submit {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1rem;
        background: #7ed957;
        color: #111;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .auth-submit:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 22px rgba(126, 217, 87, 0.3);
      }

      .auth-switch {
        font-size: 0.9rem;
        text-align: center;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        justify-content: center;
        align-items: center;
      }

      .auth-switch button {
        background: none;
        border: none;
        color: #7ed957;
        font-weight: 600;
        cursor: pointer;
        text-decoration: underline;
      }

      .auth-error {
        min-height: 1.25rem;
        color: #ff7a7a;
        text-align: center;
        font-size: 0.85rem;
      }

      .app-header {
        position: sticky;
        top: 0;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        justify-content: flex-end;
        padding: 1rem;
        background: rgba(16, 16, 16, 0.8);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        z-index: 10;
      }

      .nav-links {
        display: flex;
        gap: 0.5rem;
        margin-right: auto;
      }

      .nav-links a {
        padding: 0.45rem 0.85rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        font-size: 0.8rem;
        text-decoration: none;
        transition: background 0.2s ease;
      }

      .nav-links a:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .role-badge {
        padding: 0.4rem 0.85rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        font-size: 0.8rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .sign-out {
        border: none;
        border-radius: 999px;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        backdrop-filter: blur(4px);
        transition: background 0.2s ease;
      }

      .sign-out:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .admin-layout {
        padding: 2rem clamp(1rem, 6vw, 4rem);
        display: flex;
        justify-content: center;
      }

      .panel {
        width: min(960px, 100%);
        background: rgba(24, 24, 24, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 1rem;
        padding: clamp(1.25rem, 4vw, 2rem);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .table-wrapper {
        border-radius: 0.75rem;
        overflow: auto;
        max-height: clamp(320px, 60vh, 520px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .panel header h1 {
        font-size: clamp(1.4rem, 3vw, 1.9rem);
      }

      .panel header p {
        margin-top: 0.5rem;
        color: rgba(255, 255, 255, 0.7);
      }

      .status {
        min-height: 1.25rem;
        font-size: 0.9rem;
      }

      .status.error {
        color: #ff7a7a;
      }

      .status.success {
        color: #7ed957;
      }

      .loading {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.75);
      }

      .loading::before {
        content: "";
        width: 1.1rem;
        height: 1.1rem;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-top-color: #7ed957;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .roles-table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 0.75rem;
        overflow: hidden;
      }

      .roles-table thead {
        background: rgba(255, 255, 255, 0.06);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
      }

      .roles-table th,
      .roles-table td {
        padding: 0.85rem 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }

      .roles-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.04);
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .actions button {
        border: none;
        border-radius: 999px;
        padding: 0.4rem 0.85rem;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, background 0.15s ease;
      }

      .actions button.promote {
        background: rgba(126, 217, 87, 0.2);
        color: #7ed957;
      }

      .actions button.demote {
        background: rgba(255, 122, 122, 0.2);
        color: #ff7a7a;
      }

      .actions button.neutral {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }

      .actions button:disabled {
        opacity: 0.35;
        cursor: not-allowed;
      }

      .neutral-note {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.65);
      }

      .empty-state {
        text-align: center;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.95rem;
      }

      .unauthorized {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.85);
        z-index: 30;
        padding: 2rem;
        text-align: center;
      }

      .unauthorized button {
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div id="authOverlay" class="auth-overlay" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <form id="authForm" class="auth-card">
        <h1 id="authTitle">Sign in to continue</h1>
        <label class="auth-field">
          <span>Email</span>
          <input id="authEmail" type="email" name="email" autocomplete="email" required />
        </label>
        <label class="auth-field">
          <span>Password</span>
          <input id="authPassword" type="password" name="password" autocomplete="current-password" minlength="6" required />
        </label>
        <p id="authError" class="auth-error" role="alert" aria-live="assertive"></p>
        <button type="submit" class="auth-submit">Sign In</button>
        <p class="auth-switch">
          <span id="authSwitchLabel">Don't have an account?</span>
          <button type="button" id="toggleAuthMode">Create one</button>
        </p>
      </form>
    </div>

    <div id="adminContent" class="hidden">
      <header class="app-header">
        <nav class="nav-links" aria-label="Available pages">
          <a href="index.html">Preview</a>
          <a href="setter.html">Setter Tools</a>
        </nav>
        <span id="roleBadge" class="role-badge hidden" aria-live="polite"></span>
        <button id="signOutButton" class="sign-out">Sign out</button>
      </header>

      <main class="admin-layout">
        <section class="panel" aria-labelledby="adminTitle">
          <header>
            <h1 id="adminTitle">Manage team roles</h1>
            <p>Promote setters, demote climbers, or elevate another admin from a single dashboard.</p>
          </header>

          <p id="statusRegion" class="status" role="status" aria-live="polite"></p>
          <div id="loadingState" class="loading">Loading user roles…</div>

          <div class="table-wrapper">
            <table class="roles-table" aria-describedby="adminTitle">
              <thead>
                <tr>
                  <th scope="col">User</th>
                  <th scope="col">Role</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody id="rolesTableBody"></tbody>
            </table>
          </div>
          <p id="emptyState" class="empty-state hidden">No users found yet. Invite teammates to get started.</p>
        </section>
      </main>
    </div>

    <div id="unauthorizedNotice" class="unauthorized hidden" role="alert">
      <p><strong>Access denied.</strong> This page is reserved for administrators.</p>
      <p>You can return to the <a href="index.html">preview</a> or <a href="setter.html">setter tools</a> if you have access.</p>
      <button id="unauthorizedSignOut" class="auth-submit" type="button">Sign Out</button>
    </div>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
      } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        serverTimestamp,
        collection,
        getDocs,
        query,
        limit,
        orderBy,
        onSnapshot,
      } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyCUKr8bmjIfICZwXDHE7xoaBbAXizJhx3I',
        authDomain: 'anuascend-3f734.firebaseapp.com',
        projectId: 'anuascend-3f734',
        storageBucket: 'anuascend-3f734.firebasestorage.app',
        messagingSenderId: '305441086779',
        appId: '1:305441086779:web:0079c53daf3462bc82eb1e',
        measurementId: 'G-MNT686PF8L',
      };

      const firebaseApp = initializeApp(firebaseConfig);
      const auth = getAuth(firebaseApp);
      const db = getFirestore(firebaseApp);

      const authOverlay = document.getElementById('authOverlay');
      const adminContent = document.getElementById('adminContent');
      const authForm = document.getElementById('authForm');
      const authEmail = document.getElementById('authEmail');
      const authPassword = document.getElementById('authPassword');
      const authError = document.getElementById('authError');
      const authTitle = document.getElementById('authTitle');
      const authSwitchLabel = document.getElementById('authSwitchLabel');
      const toggleAuthModeButton = document.getElementById('toggleAuthMode');
      const signOutButton = document.getElementById('signOutButton');
      const unauthorizedSignOut = document.getElementById('unauthorizedSignOut');
      const unauthorizedNotice = document.getElementById('unauthorizedNotice');
      const roleBadge = document.getElementById('roleBadge');
      const statusRegion = document.getElementById('statusRegion');
      const loadingState = document.getElementById('loadingState');
      const rolesTableBody = document.getElementById('rolesTableBody');
      const emptyState = document.getElementById('emptyState');

      let authMode = 'login';
      let unsubscribeRoles = null;
      let currentUserId = null;
      let isProcessingUpdate = false;

      function setAuthMode(mode) {
        authMode = mode;
        const isLogin = authMode === 'login';
        authTitle.textContent = isLogin ? 'Sign in to continue' : 'Create your account';
        authSwitchLabel.textContent = isLogin ? "Don't have an account?" : 'Already have an account?';
        toggleAuthModeButton.textContent = isLogin ? 'Create one' : 'Sign in';
        authForm.querySelector('.auth-submit').textContent = isLogin ? 'Sign In' : 'Create Account';
        authPassword.setAttribute('autocomplete', isLogin ? 'current-password' : 'new-password');
        authError.textContent = '';
      }

      toggleAuthModeButton.addEventListener('click', () => {
        setAuthMode(authMode === 'login' ? 'register' : 'login');
      });

      authForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        authError.textContent = '';
        const email = authEmail.value.trim();
        const password = authPassword.value;

        try {
          if (authMode === 'login') {
            await signInWithEmailAndPassword(auth, email, password);
          } else {
            await createUserWithEmailAndPassword(auth, email, password);
          }
        } catch (error) {
          authError.textContent = error.message;
        }
      });

      function resetStatus() {
        statusRegion.textContent = '';
        statusRegion.className = 'status';
      }

      function setStatus(message, tone = 'neutral') {
        statusRegion.textContent = message;
        statusRegion.className = `status ${tone !== 'neutral' ? tone : ''}`.trim();
      }

      signOutButton.addEventListener('click', () => {
        signOut(auth).catch((error) => {
          console.error('Failed to sign out:', error);
        });
      });

      unauthorizedSignOut.addEventListener('click', () => {
        signOut(auth).catch((error) => {
          console.error('Failed to sign out:', error);
        });
      });

      async function ensureUserRole(user) {
        if (!user) {
          return null;
        }

        const roleRef = doc(db, 'roles', user.uid);
        const existingSnap = await getDoc(roleRef);

        if (existingSnap.exists()) {
          return existingSnap.data();
        }

        let role = 'climber';

        try {
          const snapshot = await getDocs(query(collection(db, 'roles'), limit(1)));
          if (snapshot.empty) {
            role = 'admin';
          }
        } catch (error) {
          console.warn('Unable to inspect existing roles:', error);
        }

        const roleData = {
          role,
          email: user.email ?? '',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        };

        await setDoc(roleRef, roleData);
        return roleData;
      }

      async function resolveUserRole(user) {
        if (!user) {
          return null;
        }

        try {
          const roleRef = doc(db, 'roles', user.uid);
          const roleSnap = await getDoc(roleRef);
          if (roleSnap.exists()) {
            return roleSnap.data().role;
          }

          const createdRole = await ensureUserRole(user);
          return createdRole ? createdRole.role : null;
        } catch (error) {
          console.error('Failed to fetch user role:', error);
          return null;
        }
      }

      function showUnauthorized(role) {
        adminContent.classList.add('hidden');
        unauthorizedNotice.classList.remove('hidden');
        roleBadge.textContent = role ? role.toUpperCase() : '';
        roleBadge.classList.toggle('hidden', !role);
        resetStatus();
        if (unsubscribeRoles) {
          unsubscribeRoles();
          unsubscribeRoles = null;
        }
      }

      function showAdminDashboard(role) {
        unauthorizedNotice.classList.add('hidden');
        adminContent.classList.remove('hidden');
        roleBadge.textContent = role.toUpperCase();
        roleBadge.classList.remove('hidden');
      }

      function clearTable() {
        rolesTableBody.innerHTML = '';
      }

      function createActionButton(label, role, tone, userId, disabled) {
        const button = document.createElement('button');
        button.type = 'button';
        button.textContent = label;
        button.dataset.role = role;
        button.classList.add(tone);
        button.disabled = disabled;
        button.addEventListener('click', () => {
          if (disabled || isProcessingUpdate) {
            return;
          }
          updateUserRole(userId, role);
        });
        return button;
      }

      function renderRoles(snapshot) {
        clearTable();
        loadingState.classList.add('hidden');
        emptyState.classList.toggle('hidden', snapshot.size !== 0);

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const row = document.createElement('tr');
          const userCell = document.createElement('td');
          const roleCell = document.createElement('td');
          const actionsCell = document.createElement('td');
          actionsCell.classList.add('actions');

          const email = data.email || 'Unknown email';
          userCell.textContent = email;
          roleCell.textContent = data.role ?? '—';

          if (docSnap.id === currentUserId) {
            const badge = document.createElement('span');
            badge.textContent = 'You';
            badge.style.display = 'inline-block';
            badge.style.marginLeft = '0.75rem';
            badge.style.fontSize = '0.75rem';
            badge.style.textTransform = 'uppercase';
            badge.style.letterSpacing = '0.05em';
            badge.style.opacity = '0.7';
            userCell.appendChild(badge);
          }

          if (docSnap.id === currentUserId) {
            const note = document.createElement('span');
            note.textContent = 'Cannot modify your own role';
            note.classList.add('neutral-note');
            actionsCell.appendChild(note);
          } else {
            const { role } = data;
            const makeAdminButton = createActionButton('Make admin', 'admin', 'neutral', docSnap.id, role === 'admin');
            const makeSetterButton = createActionButton('Promote to setter', 'setter', 'promote', docSnap.id, role === 'setter');
            const makeClimberButton = createActionButton('Demote to climber', 'climber', 'demote', docSnap.id, role === 'climber');

            actionsCell.appendChild(makeAdminButton);
            actionsCell.appendChild(makeSetterButton);
            actionsCell.appendChild(makeClimberButton);
          }

          row.appendChild(userCell);
          row.appendChild(roleCell);
          row.appendChild(actionsCell);
          rolesTableBody.appendChild(row);
        });
      }

      async function updateUserRole(userId, role) {
        if (isProcessingUpdate) {
          return;
        }

        isProcessingUpdate = true;
        setStatus('Updating role…');

        try {
          const roleRef = doc(db, 'roles', userId);
          await updateDoc(roleRef, {
            role,
            updatedAt: serverTimestamp(),
          });
          setStatus('Role updated successfully.', 'success');
        } catch (error) {
          console.error('Failed to update role:', error);
          setStatus('Failed to update role. Please try again.', 'error');
        } finally {
          isProcessingUpdate = false;
          setTimeout(() => {
            if (!isProcessingUpdate) {
              resetStatus();
            }
          }, 2500);
        }
      }

      function subscribeToRoles() {
        if (unsubscribeRoles) {
          unsubscribeRoles();
        }

        const rolesQuery = query(collection(db, 'roles'), orderBy('createdAt'));
        unsubscribeRoles = onSnapshot(
          rolesQuery,
          (snapshot) => {
            renderRoles(snapshot);
          },
          (error) => {
            console.error('Failed to subscribe to roles:', error);
            setStatus('Failed to load user roles. Please refresh the page.', 'error');
            loadingState.classList.add('hidden');
          }
        );
      }

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          authOverlay.classList.add('hidden');
          currentUserId = user.uid;

          const role = await resolveUserRole(user);

          if (!role) {
            authError.textContent = 'Unable to determine your role. Please try again later.';
            await signOut(auth);
            return;
          }

          if (role !== 'admin') {
            showUnauthorized(role);
            return;
          }

          showAdminDashboard(role);
          resetStatus();
          loadingState.classList.remove('hidden');
          subscribeToRoles();
        } else {
          currentUserId = null;
          authOverlay.classList.remove('hidden');
          adminContent.classList.add('hidden');
          unauthorizedNotice.classList.add('hidden');
          roleBadge.classList.add('hidden');
          clearTable();
          if (unsubscribeRoles) {
            unsubscribeRoles();
            unsubscribeRoles = null;
          }
          authForm.reset();
          setAuthMode('login');
        }
      });

      setAuthMode('login');
    </script>
  </body>
</html>
